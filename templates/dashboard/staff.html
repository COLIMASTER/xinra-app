{% extends "_base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div class="xinra-shell">
  <div class="dashboard-title">Dashboard</div>
  <div class="welcome-band mt-2">
    <div>
      <div class="fw-semibold">Welcome back, {{ staff.name }}</div>
      <div class="text-muted">{{ restaurant.name }}</div>
    </div>
    {% set staff_avatar = staff.avatar_url %}
    {% if staff_avatar and 'placehold.co/96x96' in staff_avatar %}
      {% set staff_avatar = staff_avatar|replace('placehold.co/96x96', 'placehold.co/600x600') %}
    {% endif %}
    {% if staff_avatar %}
      <img src="{{ staff_avatar }}" alt="{{ staff.name }}" class="staff-avatar" style="margin:0;">
    {% else %}
      <div class="staff-avatar fallback" style="margin:0;">{{ staff.name[:1].upper() }}</div>
    {% endif %}
  </div>
  <div class="text-muted small mt-2">{{ today_label }}</div>

  <div class="card tier-card p-3 mt-3">
    <div class="fw-semibold">Rewards & Recognition</div>
    {% if current_tier %}
      <div class="h5 mt-1">{{ current_tier.name }} Tier</div>
      <div class="muted">XP: {{ user_xp }}</div>
      {% if next_tier %}
        <div class="muted">Next: {{ next_tier.name }} at {{ next_tier.threshold_xp }} XP</div>
      {% else %}
        <div class="muted">Top tier achieved</div>
      {% endif %}
    {% else %}
      <div class="muted">No tier data yet.</div>
    {% endif %}
  </div>

  <div class="section-title">Today's summary</div>
  <div class="kpi-grid">
    <div class="kpi-card">
      <div class="text-muted">Today's tips</div>
      <div class="kpi-value">${{ '%.2f' % (tips_today/100) }}</div>
      <div class="kpi-sub">{{ '+' if tips_growth_pct >= 0 else '' }}{{ tips_growth_pct }}%</div>
    </div>
    <div class="kpi-card">
      <div class="text-muted">Reviews - avg rating</div>
      <div class="kpi-value">{{ '%.1f' % rating_avg_week }} <i class="bi bi-star-fill" style="color:var(--xinra-orange);"></i></div>
      <div class="kpi-sub">{{ '+' if reviews_delta >= 0 else '' }}{{ reviews_delta }} reviews</div>
    </div>
  </div>

  <div class="section-title">Tips by shift</div>
  <div class="chart-panel">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <div class="fw-semibold">Metrics Summary</div>
      <select class="form-select" style="max-width:160px;" id="shift-range">
        <option value="week">This week</option>
        <option value="month">This month</option>
      </select>
    </div>
    <div style="height:260px;"><canvas id="shiftChart"></canvas></div>
  </div>

  <div class="section-title">Total tips</div>
  <div class="kpi-grid">
    <div class="kpi-card">
      <div class="text-muted">This period</div>
      <div class="kpi-value">${{ '%.2f' % (total_tips/100) }}</div>
      <div class="kpi-sub">Growth vs last week</div>
      <div class="fw-semibold" style="color:var(--xinra-orange);">{{ '+' if week_growth_pct >= 0 else '' }}{{ week_growth_pct }}%</div>
    </div>
    <div class="kpi-card">
      <div class="text-muted">Avg. rating</div>
      <div class="kpi-value" style="color:var(--xinra-orange);">{{ '%.1f' % rating_avg_week }}</div>
      <div class="kpi-sub">Based on {{ reviews_week_count }} reviews</div>
    </div>
  </div>

  <div class="section-title">Top performers this week</div>
  <div class="top-staff-grid">
    {% for item in top_staff %}
      <div class="top-staff-card">
        {% set top_avatar = item.staff.avatar_url %}
        {% if top_avatar and 'placehold.co/96x96' in top_avatar %}
          {% set top_avatar = top_avatar|replace('placehold.co/96x96', 'placehold.co/600x600') %}
        {% endif %}
        {% if top_avatar %}
          <img src="{{ top_avatar }}" alt="{{ item.staff.name }}" class="top-staff-photo">
        {% else %}
          <div class="top-staff-photo top-staff-fallback">
            <div class="staff-initial">{{ item.staff.name[:1].upper() }}</div>
          </div>
        {% endif %}
        <div class="top-staff-body">
          <div class="top-staff-rank">{{ item.rank_label }}</div>
          <div class="top-staff-name">{{ item.staff.name }}</div>
          <div class="top-staff-role">{{ item.staff.role or 'Staff' }}</div>
          <div class="top-staff-stats">
            <div class="top-staff-stat">
              <span>Tips</span>
              <strong>${{ '%.2f' % (item.tips_total/100) }}</strong>
            </div>
            <div class="top-staff-stat">
              <span>Rating</span>
              <strong>{{ '%.1f' % item.rating_avg }}</strong>
            </div>
            <div class="top-staff-stat">
              <span>Reviews</span>
              <strong>{{ item.reviews_count }}</strong>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <div class="d-grid mt-4">
    <a class="btn btn-primary btn-lg" href="{{ url_for('dashboard.staff_breakdown') }}">View detailed Breakdown</a>
  </div>

  <div class="section-title">Recent reviews</div>
  {% if recent_reviews %}
    <div class="review-grid">
      {% for r in recent_reviews %}
        <div class="review-card">
          <div class="d-flex justify-content-between">
            <div class="fw-semibold">{{ r.staff.name if r.staff_id else 'General' }}</div>
            <div class="text-muted small">{{ r.created_at.strftime('%Y-%m-%d') }}</div>
          </div>
          <div class="review-stars">
            {% for i in range(1,6) %}
              {% if i <= r.rating %}
                <i class="bi bi-star-fill"></i>
              {% else %}
                <i class="bi bi-star"></i>
              {% endif %}
            {% endfor %}
          </div>
          {% if r.comment %}
            <div class="text-muted mt-2">{{ r.comment }}</div>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="text-muted">No reviews yet.</div>
  {% endif %}

  <div class="section-title">Instant Tip Transfer</div>
  <div class="section-subtitle">End your shift, collect your reward.</div>
  <div class="transfer-panel mt-2">
    <div class="kpi-value">${{ '%.2f' % (pending_balance/100) }}</div>
    <div class="text-muted mb-3">Available to transfer</div>

    <div class="d-grid gap-2 mb-3">
      <label class="bank-option">
        <input type="radio" name="bank_choice" checked>
        <div>
          <div class="fw-semibold">XINRA Checking</div>
          <div class="text-muted small">**** 4821</div>
        </div>
      </label>
      <label class="bank-option">
        <input type="radio" name="bank_choice">
        <div>
          <div class="fw-semibold">Savings</div>
          <div class="text-muted small">**** 1174</div>
        </div>
      </label>
    </div>

    <div class="card p-3 mb-3" style="box-shadow:none;">
      <div class="text-muted">Estimated arrival</div>
      <div class="fw-semibold">Within minutes</div>
    </div>

    <form method="post" action="{{ url_for('dashboard.staff_transfer') }}" class="d-flex gap-2">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <a class="btn btn-outline-orange w-100" href="{{ url_for('dashboard.my_staff_panel') }}">Cancel</a>
      <button class="btn btn-primary w-100" type="submit">Confirm</button>
    </form>
  </div>
</div>

<script id="shiftData" type="application/json">
  {{ {
    'week': {'labels': week_labels, 'totals': week_totals},
    'month': {'labels': month_labels, 'totals': month_totals}
  } | tojson | safe }}
</script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const dataEl = document.getElementById('shiftData');
    const ctx = document.getElementById('shiftChart');
    if (!dataEl || !ctx || !window.Chart) return;
    const payload = JSON.parse(dataEl.textContent);
    const rangeSelect = document.getElementById('shift-range');
    const money = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });

    const maxLabelPlugin = {
      id: 'maxLabel',
      afterDatasetsDraw(chart) {
        const {ctx, data, chartArea} = chart;
        if (!chartArea) return;
        const dataset = data.datasets[0];
        const totals = dataset.data;
        if (!totals.length) return;
        const maxVal = Math.max(...totals);
        const maxIndex = totals.indexOf(maxVal);
        const meta = chart.getDatasetMeta(0);
        const bar = meta.data[maxIndex];
        if (!bar) return;
        const x = bar.x;
        const radius = 12;
        let y = bar.y + radius - 2;
        if (y + radius > bar.base) {
          y = bar.base - radius;
        }
        ctx.save();
        ctx.fillStyle = '#ffffff';
        ctx.beginPath();
        ctx.arc(x, y, radius, 0, Math.PI * 2);
        ctx.fill();
        ctx.strokeStyle = '#f27a2d';
        ctx.lineWidth = 2;
        ctx.stroke();
        ctx.fillStyle = '#111111';
        ctx.font = '600 11px Manrope';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(money.format(maxVal / 100), x, y);
        ctx.restore();
      }
    };

    let chart = null;
    const buildChart = (range) => {
      const labels = payload[range].labels;
      const totals = payload[range].totals;
      const maxVal = Math.max(...totals, 0);
      const colors = totals.map(val => val === maxVal ? '#f27a2d' : '#e5e7eb');

      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ data: totals, backgroundColor: colors, borderRadius: 14, borderSkipped: false }] },
        options: {
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, ticks: { callback: (v) => money.format(v / 100) } },
            x: { grid: { display: false } }
          }
        },
        plugins: [maxLabelPlugin]
      });
    };

    buildChart('week');
    rangeSelect.addEventListener('change', () => buildChart(rangeSelect.value));
  });
</script>
{% endblock %}
