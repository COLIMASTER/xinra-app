{% extends "_base.html" %}
{% block title %}Leave a Tip - {{ restaurant.name }}{% endblock %}
{% block content %}
<div class="xinra-shell">
  <div class="card p-3 text-center mb-4">
    {% if restaurant.logo_url %}
      <img src="{{ restaurant.logo_url }}" alt="{{ restaurant.name }} logo" class="restaurant-logo-small">
    {% endif %}
    <div class="section-title" style="margin:0;">{{ restaurant.name }}</div>
    <div class="text-muted">Thank you for dinning with us!</div>
  </div>

  <form method="post" id="tip-form" class="card p-3">
    {{ form.hidden_tag() }}
    {{ form.restaurant_id }}
    {{ form.staff_id }}

    <div class="section-title">Who would you like to recognise today?</div>
    <div class="staff-grid">
      {% for s in staff_list %}
      <div class="staff-tile" data-staff-id="{{ s.id }}">
        {% set avatar = s.avatar_url %}
        {% if avatar and 'placehold.co/96x96' in avatar %}
          {% set avatar = avatar|replace('placehold.co/96x96', 'placehold.co/600x600') %}
        {% endif %}
        {% if avatar %}
          <img src="{{ avatar }}" alt="{{ s.name }}" class="staff-photo-img">
        {% else %}
          <div class="staff-photo staff-photo-fallback">
            <div class="staff-initial">{{ s.name[:1].upper() }}</div>
          </div>
        {% endif %}
        <div class="staff-name-panel">{{ s.name }}</div>
      </div>
      {% endfor %}
    </div>

    <div class="section-title">Choose your tip amount</div>
    <div class="tip-options mb-2">
      <button type="button" class="choice-btn amount-btn" data-amount="200">$2</button>
      <button type="button" class="choice-btn amount-btn" data-amount="500">$5</button>
      <button type="button" class="choice-btn amount-btn" data-amount="1000">$10</button>
      <button type="button" class="choice-btn amount-btn" data-amount="3000">$30</button>
    </div>
    <div class="mb-3">
      <label class="form-label">Enter your custom amount</label>
      <div class="input-group">
        <span class="input-group-text">$</span>
        <input type="number" min="1" step="1" class="form-control" id="amount-dollars" placeholder="Custom amount">
      </div>
      {{ form.amount_cents(class="d-none") }}
    </div>

    <div class="section-title">Payment methods</div>
    <div class="payment-options mb-4">
      <button type="button" class="choice-btn method-btn" data-method="apple_pay"><i class="bi bi-apple me-1"></i>Apple Pay</button>
      <button type="button" class="choice-btn method-btn" data-method="google_pay"><i class="bi bi-google me-1"></i>Google Pay</button>
      <button type="button" class="choice-btn method-btn" data-method="paypal"><i class="bi bi-paypal me-1"></i>PayPal</button>
    </div>
    {{ form.method_ui(class="d-none") }}

    <div class="d-grid">
      <button class="btn btn-primary btn-lg" type="submit">Leave Tip</button>
    </div>
    <div class="fine-print">100% of your tip goes directly to staff.</div>
  </form>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const amountCents = document.getElementById('amount_cents');
    const amountDollars = document.getElementById('amount-dollars');
    const methodUi = document.getElementById('method_ui');
    const staffId = document.getElementById('staff_id');

    const setActive = (buttons, target) => {
      buttons.forEach(btn => btn.classList.toggle('is-active', btn === target));
    };

    const amountButtons = document.querySelectorAll('.amount-btn');
    amountButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        amountCents.value = btn.dataset.amount;
        amountDollars.value = '';
        setActive(amountButtons, btn);
      });
    });

    amountDollars.addEventListener('input', () => {
      const val = parseInt(amountDollars.value || '0', 10);
      amountCents.value = isNaN(val) ? '' : (val * 100);
      amountButtons.forEach(btn => btn.classList.remove('is-active'));
    });

    const methodButtons = document.querySelectorAll('.method-btn');
    methodButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        methodUi.value = btn.dataset.method;
        setActive(methodButtons, btn);
      });
    });

    if (methodUi.value) {
      const preset = Array.from(methodButtons).find(btn => btn.dataset.method === methodUi.value);
      if (preset) preset.classList.add('is-active');
    } else if (methodButtons.length) {
      methodButtons[0].click();
    }

    document.querySelectorAll('.staff-tile').forEach(card => {
      card.addEventListener('click', () => {
        staffId.value = card.dataset.staffId;
        document.querySelectorAll('.staff-tile').forEach(c => c.classList.remove('is-selected'));
        card.classList.add('is-selected');
      });
    });
  });
</script>
{% endblock %}
